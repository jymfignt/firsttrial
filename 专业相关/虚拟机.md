>2024.8.10记，存个档

虚拟机的运行原理涉及到一系列复杂的软件和硬件技术。要详细了解虚拟机的运行原理，我们需要从以下几个方面展开：虚拟机监视器（Hypervisor）的角色、虚拟化技术的实现、硬件虚拟化的支持以及虚拟机的运行过程。下面将逐步详细介绍。

## **1.虚拟机监视器（Hypervisor）的角色**

虚拟机的核心组件是**虚拟机监视器（*Hypervisor*）**，它是虚拟化的关键。Hypervisor 用于在物理硬件和虚拟机之间进行资源的协调、调度和隔离。根据部署方式，Hypervisor 分为两种类型：类型 1（裸机型）和类型 2（托管型）。

### **1.类型 1 Hypervisor（裸机型）**

  - **直接安装在物理硬件上**，不依赖底层的操作系统，直接管理计算机硬件资源。

  - 能够直接访问 CPU、内存和 I/O 设备，通过硬件虚拟化来提高性能。

  - **例子**：`VMware ESXi`、`Microsoft Hyper-V`、`Xen`。

  - **工作原理**：
	类型 1 Hypervisor 会直接与硬件通信，负责为每个虚拟机创建和管理虚拟化硬件环境，包括虚拟 CPU、内存、存储和网络适配器。
	在虚拟机运行时，Hypervisor 将负责分配物理资源给虚拟机，并保证各虚拟机之间的隔离。它可以控制虚拟机对硬件的访问，拦截和处理虚拟机发出的硬件操作请求，以防止虚拟机直接操控底层硬件。

### **2. 类型2 Hypervisor（托管型）**

  - **运行在主机操作系统之上**，将物理硬件虚拟化成一组虚拟设备，供每个虚拟机使用。

  - 适合在个人电脑上进行虚拟化测试，虽然性能不及类型 1，但部署方便。

  - **例子**：VMware Workstation、Oracle VirtualBox。
  - **工作原理**：
	  类型 2 Hypervisor 作为一款应用程序运行在主机操作系统上。它将主机操作系统的硬件资源（如 CPU、内存、硬盘、网络）抽象为虚拟硬件，然后将这些虚拟硬件提供给每个虚拟机使用。
	  当虚拟机运行时，它的所有硬件操作请求都会被托管型 Hypervisor 拦截，然后通过主机操作系统去执行。这种方式在软件层面模拟硬件，性能上会受到主机操作系统的影响。

 
## **2. 虚拟化技术的实现**

  虚拟化主要依赖于虚拟机监视器的核心功能，它需要模拟和管理硬件资源，为每个虚拟机提供一个隔离的运行环境。这涉及到以下关键技术：
 
### **1.CPU虚拟化**

  - **原理**：虚拟机监视器在物理 CPU 上创建多个**虚拟CPU（vCPU）**。每个虚拟机会认为它拥有自己的 CPU，但实际上这些 vCPU 是共享物理 CPU 资源的。

  - **过程**：

    1. 虚拟机中的操作系统和应用程序会向虚拟 CPU 发出指令。

    2. 虚拟机监视器拦截这些指令，将它们映射到物理 CPU 上执行。

    3. 虚拟机监视器在各个虚拟机之间调度 CPU 资源，确保每个虚拟机都能获得一定的计算时间片。

  - **挑战**：一些 CPU 指令（如特权指令）是操作系统用来直接管理硬件的。虚拟机监视器必须拦截这些特权指令，以防止虚拟机直接操作物理硬件。这种拦截和模拟的过程会带来一定的性能开销。

###  **2. 内存虚拟化**

  - **原理**：虚拟机监视器为每个虚拟机提供一块**虚拟内存**。每个虚拟机认为它拥有独立的内存空间，实际上这些虚拟内存会被映射到物理内存上。

  - **过程**：

    1. 虚拟机内的操作系统会向虚拟内存发起读写请求。

    2. 虚拟机监视器将这些虚拟内存地址映射到物理内存地址，以控制内存的分配。

    3. 在现代 CPU 中，使用硬件支持（如 Intel 的 EPT、AMD 的 RVI）来加速这种映射过程，减少虚拟机监视器的开销。

  - **挑战**：确保各虚拟机的内存空间互不干扰，并且能够动态分配和管理内存资源，防止内存泄露和数据冲突。

### **3. 设备虚拟化**

  - **原理**：虚拟机监视器为每个虚拟机模拟硬件设备（如硬盘、网络适配器），从而使虚拟机能够以为它在使用真实的硬件设备。

  - **过程**：

   1. 虚拟机向虚拟硬件（如虚拟网卡、虚拟硬盘）发起操作请求。

   2. 虚拟机监视器将这些操作请求映射到实际的物理硬件，并执行相应的操作。

   3. Hypervisor 负责将不同虚拟机的硬件操作隔离，以保证各虚拟机之间互不干扰。

  - **挑战**：设备虚拟化需要虚拟机监视器模拟真实硬件设备的行为，这增加了虚拟机的灵活性，但也增加了监视器的复杂性和性能开销。

### **4. I/O虚拟化**

  - **原理**：虚拟机监视器负责处理虚拟机的输入输出请求，例如磁盘读写、网络通信等。它需要高效地在虚拟机和物理硬件之间中转数据。

  - **过程**：

    1. 虚拟机发出 I/O 请求（如读写磁盘、发送网络数据）。

    2. 虚拟机监视器拦截这些请求，将其转发给物理设备执行。

    3. 在硬件支持下（如 Intel 的 VT-d），虚拟机监视器可以直接分配物理 I/O 设备给虚拟机，减少中间的性能开销。

## **3.** **硬件虚拟化的支持**

为了提升虚拟机的性能，现代 CPU 和芯片组提供了专门的硬件虚拟化支持，如 Intel 的 VT-x 和 AMD 的 AMD-V。这些技术让虚拟机可以更高效地直接访问硬件资源，减少 Hypervisor 的干预。

### ** 1. 软件虚拟化**

  - **VT-x（Intel）和 **AMD-V**：提供了虚拟化指令集，使得虚拟机的特权指令可以直接在硬件层面执行，避免了 Hypervisor 的频繁拦截，从而提高虚拟机的性能。

### **2. 内存硬件虚拟化**

  - **EPT****（****Extended Page Tables****）和** **RVI****（****Rapid Virtualization Indexing****）**：这些技术提供了内存地址的硬件映射支持，简化了虚拟内存到物理内存的映射过程，加快了内存访问速度。

### **3. I/O 硬件虚拟化**

  - **VT-d**：允许虚拟机直接控制物理 I/O 设备，如网卡和硬盘，这样虚拟机的 I/O 操作不再需要 Hypervisor 的中转，显著提高了 I/O 性能。

## **4.** **虚拟机的运行过程**

  1. **创建虚拟机**：虚拟机监视器分配虚拟硬件资源（CPU、内存、硬盘、网络等），并为虚拟机创建一个独立的运行环境。

  2. **加载操作系统**：虚拟机通过 Hypervisor 提供的虚拟硬件加载操作系统。虚拟机监视器会拦截操作系统的硬件访问请求，将其转发到实际硬件执行。

  3. **运行应用程序**：在虚拟机中运行应用程序时，应用程序的指令会传递给虚拟 CPU。Hypervisor 对这些指令进行处理，并负责调度物理 CPU、内存和 I/O 资源。

  4. **硬件资源调度**：Hypervisor 使用硬件虚拟化支持，将物理硬件资源动态分配给虚拟机，确保资源的高效利用和隔离。

  5. **隔离与安全**：Hypervisor 负责确保各虚拟机的操作和数据隔离，防止一个虚拟机的崩溃或攻击影响其他虚拟机。

## **5.虚拟机的两种类型对比**

   虚拟机（VM）主要通过两种类型的虚拟机监视器（Hypervisor）来实现，这两种类型分别是**类型1（裸机型Hypervisor）** 和**类型2（托管型Hypervisor）**。以下是它们的详细对比：

**_1._** **类型1裸机型Hypervisor）**

**定义**：类型 1 Hypervisor 是直接运行在物理硬件上的虚拟化软件，不依赖底层的操作系统。

**特性**：

  - **安装位置**：直接运行在硬件之上，无需操作系统作为中间层。

  - **性能**：由于直接控制硬件，类型 1 的性能更高，延迟更低，非常适合用于需要高效处理大量虚拟机的企业级环境。

  - **资源管理**：类型 1 直接管理硬件资源（如 CPU、内存、存储、I/O 设备），因此调度效率更高。

  - **隔离性**：能够提供高度的隔离与安全性，因为没有操作系统的干预，系统资源的分配和控制完全由 Hypervisor 掌控。

**优点**：

  - 性能高，适合高密度虚拟化环境（如数据中心、云计算）。

  - 稳定性强，适合长时间运行的任务。

  - 提供更好的安全性和资源隔离。

**缺点**：

  - 部署和管理较为复杂。

  - 需要专门的硬件支持和配置。

**常见例子**：

  - **VMware ESXi**：企业级虚拟化软件。

  - **Microsoft Hyper-V**：用于服务器虚拟化。

  - **Xen**：开源虚拟化解决方案，常用于云平台。

**_2._** **类型2（托管型Hypervisor）**

**定义**：类型 2 Hypervisor 是运行在主机操作系统之上的虚拟化软件，依赖于操作系统来管理物理硬件资源。

**特性**：

  - **安装位置**：运行在操作系统之上，作为操作系统中的应用程序使用。

  - **性能**：由于需要通过操作系统访问硬件，性能较类型 1 略差，尤其在大量虚拟机或高负载的情况下。

  - **资源管理**：依赖主机操作系统进行硬件资源的调度，Hypervisor 在此基础上分配资源给虚拟机。

  - **隔离性**：虚拟机之间通过操作系统隔离，安全性和隔离性不如类型 1 高。

**优点**：

  - 部署简单，适合个人用户和轻量级的开发、测试环境。

  - 不需要专门的硬件支持，只要有操作系统就可以运行。

**缺点**：

  - 性能较低，特别是当多个虚拟机同时运行时，会受到主机操作系统的影响。

  - 资源调度效率较低，适合轻量化使用场景。

**常见例子**：

  - **VMware Workstation**：常用于个人电脑和开发环境的虚拟化解决方案。

  - **Oracle VirtualBox**：免费开源，适合个人使用。

  - **Parallels Desktop**：常用于在 macOS 上运行 Windows 系统。

## **6.WSL（Windows Subsystem for Linux）与虚拟化的关系**

**Windows Subsystem for Linux（WSL）** 是一种特别的虚拟化环境，它允许用户在 Windows 操作系统中运行 Linux 二进制文件（如 Ubuntu）而无需使用传统的虚拟机。因此，WSL 具有一些虚拟化的特性，但并不能严格归类为传统的虚拟机类型 1 或类型 2。

### **1. WSL 1 与虚拟机的区别**

   - **WSL 1** 使用的是一种兼容层（类似于翻译层），将 Linux 系统调用转化为 Windows 系统调用。这并非完全虚拟化，而是通过与 Windows 内核的交互来模拟 Linux 环境，所以 WSL 1 不算是真正的虚拟机。

   - **性能**：因为没有虚拟化层，它比传统虚拟机（如 VMware、VirtualBox）更轻量，性能损耗较小，适合开发者日常使用。

### **2. WSL 2 与虚拟机的关系**

   **WSL 2** 是基于实际的虚拟化技术构建的，它引入了真正的 Linux 内核，运行在轻量级的虚拟机中。WSL 2 使用了 Microsoft 的 Hyper-V 虚拟化技术，将 Linux 内核运行在一个轻量级虚拟机内，因此 WSL 2 可以视为一种虚拟机，但它不完全符合类型 1 或类型 2 的定义。

  - **WSL 2** **的架构**：基于 Hyper-V 的轻量虚拟机技术，使得 Linux 内核可以直接运行在虚拟化环境中，提供了完整的 Linux 体验。不同于传统的类型 2 Hypervisor，WSL 2 是专为在 Windows 上集成 Linux 环境设计的轻量级虚拟化。

  - **性能**：虽然使用虚拟化技术，但由于轻量级设计，WSL 2 性能更接近本地执行，比传统的虚拟机环境（如 VirtualBox）快。

### **总结：WSL属于虚拟化吗？**

  - **WSL 1** 并不属于传统的虚拟机，而是一种兼容层。

  - **WSL 2** 使用了虚拟化技术，运行在一个轻量级的虚拟机中，因此可以看作是一种特殊的虚拟机环境。

  - 如果必须分类，**WSL 2** **更接近类型** **1** **虚拟机**，因为它依赖 Hyper-V 虚拟化技术，但与传统类型 1 虚拟机不同，它并不是为了运行多个操作系统，而是为了简化 Windows 和 Linux 之间的互操作性。

## 总体对比：

| 特性   | 类型1（裸机型）            | 类型2（托管型）                      | WSL2               |
| ---- | ------------------- | ----------------------------- | ------------------ |
| 安装位置 | 直接在物理硬件上            | 操作系统之上                        | 基于Hyper-v虚拟机       |
| 性能   | 性能最高，延迟低            | 性能较低，依赖主机操作系统                 | 介于类型1和类型2之间        |
| 资源调度 | 直接管理硬件资源            | 依赖操作系统调度硬件资源                  | 轻量级虚拟机，基于Hyper-v   |
| 适用场景 | 数据中心、企业级虚拟化         | 个人开发、测试、轻量化虚拟化                | 在Windows上运行Linux环境 |
| 常见例子 | VMware ESXi、Hyper-v | VMware Workstation、VirtualBox | WSL 2（基于Ubuntu）    |

 **总结**
 虚拟机可以分为两大类：类型 1 裸机型 Hypervisor 和类型 2 托管型 Hypervisor。WSL 2 虽然使用了虚拟化技术，但它不属于传统意义上的类型 1 或类型 2 虚拟机，而是一种轻量化的特殊虚拟机环境，主要用于集成 Windows 和 Linux。
